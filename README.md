# Деплой приложения и инфры для laravel приложения

### Краткое описание всего процесса:
 - весь проект состоит из приложения и описания инфраструктуры
 - Предполагается что сначала поднимаем инфру и дальше в ней разворачиваем наше приложение
 - Отдельная репо для разворачивания инфраструктуры в облаке: https://github.com/IsieIam/infra - следовать её инструкциям.
 - Простое приложение laravel: https://github.com/IsieIam/laravel

### Структура репа:
- Local - ручной локальный стенд, основанный на docker-compose (см в каталоге подробное описание)
- Charts - helm чарт для приложения: состоит из чарта laravel-nginx - являющимся основным чартом приложения, laravel-nginx-exporter(метрики nginx) и двух зависимостей: mysql БД и memcached для кеша. Для ручного запуска достаточно создать в каталоге Charts/laravel файл values.yaml из одноименного файла example и запустить в этом каталоге команду:

```
helm install larka . -f values.yaml
# где larka - произвольное имя релиза
```

- Jenkinsfile - пример разворачивания приложения для stage и prod среды. 
Общий flow предполагается следующий: фича ветка из репо кода приложения разрабатывается на дев стенде(о нем ниже), дальше мерджится в ветку release, c которой hook уходит в job jenkins с scm на репо с деплоем. В момент старта job-а он сливает исходный код приложения из ветки release, собирает докер образ, пушит в регистри и автоматом раскатывает в stage, запускает автотесты и раскатывает в пром либо тоже автоматом либо по команде человека.
При этом возможно сделать подобный мех-зм для хука с любой ветки - взяв адрес репо и хук с метаинфы пришедшей вместе с hook, например для раскатки на dev среду feature веток.

### особенности php

Есть особенности php с которым столкнулся: дев стенд - пока видится два варианта его подготовки: локальный и в k8s.
Но есть два момента, которые необходимо решить: 
- 1. вариант быстрого деплоя кода(все-таки php это интерпретируемый язык) - в частности IDE php-storm имеет такую возможность как закинуть активный в ней файл или сразу каталог через ssh ( и еще несколько способов) сразу на удаленный dev стенд и тут же посмотреть как это отобразиться на страничке.
- 2. debug в IDE удаленного стенда.

С локальным, например в виде docker-compose в принципе все просто(ну или не очень), но так сейчас уже работает. А вот с стендом в k8s пока понятно только направление: ksync и kubectl debug и им подобные утилиты. Либо отдельный контейнер под дев среду с поднятым ssh или portforwarding.

### Соединение php-fpm и web сервера с fastcgi

В результате поиска остался один вариант запуска laravel приложения - через совмещение в одном поде двух контейнеров: nginx + phpfpm, основной проблемой является необходимость передать nginx каталог public находящийся у php приложения.

### todo
- описать deployment/helm-чарт для adminer, хотя он не совсем относится к приложению, больше это как утилита в кластере
- реализовать доставку через fluxcd
- рефакторинг кода
